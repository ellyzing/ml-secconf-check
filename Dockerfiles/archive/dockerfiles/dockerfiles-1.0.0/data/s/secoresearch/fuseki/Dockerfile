# Licensed to the Apache Software Foundation (ASF) under one or more  
# contributor license agreements. See the NOTICE file distributed with  
# this work for additional information regarding copyright ownership.  
# The ASF licenses this file to You under the Apache License, Version 2.0  
# (the "License"); you may not use this file except in compliance with  
# the License. You may obtain a copy of the License at  
#  
# http://www.apache.org/licenses/LICENSE-2.0  
#  
# Unless required by applicable law or agreed to in writing, software  
# distributed under the License is distributed on an "AS IS" BASIS,  
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  
# See the License for the specific language governing permissions and  
# limitations under the License.  
FROM java:8-jre-alpine  
  
MAINTAINER Jouni Tuominen <jouni.tuominen@aalto.fi>  
  
#RUN apk add --update pwgen bash wget ca-certificates && rm -rf
/var/cache/apk/*  
RUN apk add --update pwgen bash wget ca-certificates findutils coreutils && rm
-rf /var/cache/apk/*  
  
# Update below according to https://jena.apache.org/download/  
#ENV FUSEKI_SHA1 d7ba62fcc5230fe86a7a8e5fc79890ea37af7395  
#ENV FUSEKI_VERSION 3.7.0  
ENV FUSEKI_SHA1 22db12165b820e05f07bee5688c22db04b521467  
ENV FUSEKI_VERSION 3.6.0  
#ENV JENA_SHA1 f70dbd795872ebbd4d4a81dcfcd6317411e7b0ae  
#ENV JENA_VERSION 3.7.0  
ENV JENA_SHA1 dc209016fa1d631324839d7aaf3ccf673cc9d4fd  
ENV JENA_VERSION 3.6.0  
ENV MIRROR http://www.eu.apache.org/dist/  
ENV ARCHIVE http://archive.apache.org/dist/  
  
# Config and data  
ENV FUSEKI_BASE /fuseki-base  
  
# Fuseki installation  
ENV FUSEKI_HOME /jena-fuseki  
  
ENV JENA_HOME /jena  
ENV JENA_BIN $JENA_HOME/bin  
  
WORKDIR /tmp  
# sha1 checksum  
RUN echo "$FUSEKI_SHA1 fuseki.tar.gz" > fuseki.tar.gz.sha1  
# Download/check/unpack/move Fuseki in one go (to reduce image size)  
RUN wget -O fuseki.tar.gz $MIRROR/jena/binaries/apache-jena-
fuseki-$FUSEKI_VERSION.tar.gz || \  
wget -O fuseki.tar.gz $ARCHIVE/jena/binaries/apache-jena-
fuseki-$FUSEKI_VERSION.tar.gz && \  
sha1sum -c fuseki.tar.gz.sha1 && \  
tar zxf fuseki.tar.gz && \  
mv apache-jena-fuseki* $FUSEKI_HOME && \  
rm fuseki.tar.gz* && \  
cd $FUSEKI_HOME && rm -rf fuseki.war  
  
# Get tdbloader2 from Jena  
# sha1 checksum  
RUN echo "$JENA_SHA1 jena.tar.gz" > jena.tar.gz.sha1  
# Download/check/unpack/move Jena in one go (to reduce image size)  
RUN wget -O jena.tar.gz $MIRROR/jena/binaries/apache-jena-$JENA_VERSION.tar.gz
|| \  
wget -O jena.tar.gz $ARCHIVE/jena/binaries/apache-jena-$JENA_VERSION.tar.gz &&
\  
sha1sum -c jena.tar.gz.sha1 && \  
tar zxf jena.tar.gz && \  
mkdir -p $JENA_BIN && \  
mv apache-jena*/lib $JENA_HOME && \  
mv apache-jena*/bin/tdbloader2* $JENA_BIN && \  
rm -rf apache-jena* && \  
rm jena.tar.gz*  
  
# As "localhost" is often inaccessible within Docker container,  
# we'll enable basic-auth with a random admin password  
# (which we'll generate on start-up)  
COPY shiro.ini /jena-fuseki/shiro.ini  
COPY docker-entrypoint.sh /  
RUN chmod 755 /docker-entrypoint.sh  
  
# SeCo extensions  
COPY spatial-arq-1.0.0-SNAPSHOT-with-dependencies.jar /javalibs/  
COPY silk-arq-1.0.0-SNAPSHOT-with-dependencies.jar /javalibs/  
  
# Fuseki config  
ENV ASSEMBLER $FUSEKI_BASE/configuration/assembler.ttl  
COPY assembler.ttl $ASSEMBLER  
COPY fuseki-config.ttl $FUSEKI_BASE/config.ttl  
RUN mkdir -p $FUSEKI_BASE/databases  
  
# Set permissions to allow fuseki to run as an arbitrary user  
RUN chgrp -R 0 $FUSEKI_BASE \  
&& chmod -R g+rwX $FUSEKI_BASE  
  
# Tools for loading data  
ENV JAVA_CMD java -cp "$FUSEKI_HOME/fuseki-server.jar:/javalibs/*"  
ENV TDBLOADER $JAVA_CMD tdb.tdbloader --desc=$ASSEMBLER  
ENV TDBLOADER2 $JENA_BIN/tdbloader2 --loc=$FUSEKI_BASE/databases/tdb  
ENV TDB2TDBLOADER $JAVA_CMD tdb2.tdbloader --desc=$ASSEMBLER  
ENV TEXTINDEXER $JAVA_CMD jena.textindexer --desc=$ASSEMBLER  
ENV SPATIALINDEXER $JAVA_CMD jena.spatialindexer --desc=$ASSEMBLER  
ENV TDBSTATS $JAVA_CMD tdb.tdbstats --desc=$ASSEMBLER  
ENV TDB2TDBSTATS $JAVA_CMD tdb2.tdbstats --desc=$ASSEMBLER  
  
WORKDIR /jena-fuseki  
EXPOSE 3030  
USER 9008  
ENTRYPOINT ["/docker-entrypoint.sh"]  
CMD ["java", "-cp", "*:/javalibs/*", "org.apache.jena.fuseki.cmd.FusekiCmd"]

